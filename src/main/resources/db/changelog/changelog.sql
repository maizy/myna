--liquibase formatted sql

--changeset myna:1
create table rulesets (
  id text not null primary key,
  ruleset jsonb
);
--rollback drop table rulesets

--changeset myna:2
create index rulesets_name_idx on rulesets ((ruleset ->> 'name'), id);
--rollback drop index rulesets_name_idx

--changeset myna:3
create type game_state as enum ('created', 'upcomming', 'launched', 'finished');
--rollback drop type game_state

--changeset myna:4
create table games(
  id text not null primary key,
  ruleset_id text not null references rulesets(id),
  state game_state not null default 'created',
  created_at timestamp with time zone not null,
  finished_at timestamp with time zone,
  owner_uid text not null
);
--rollback drop table games

--changeset myna:5
create table game_players(
  game_id text not null references games(id),
  ruleset_player_id text not null,
  name text not null,
  uid text,
  join_key text,
  joined_at timestamp with time zone,
  ruleset_order int not null default 0,
  primary key (game_id, ruleset_player_id)
);
--rollback drop table game_players

--changeset myna:6
insert into rulesets (id, ruleset)
values
  ('all_features_v0', '{"id": "all_features_v0", "name": "All Features Ruleset (v0-preview)", "zones": [{"access": {"type": "static", "owners": ["p1"], "viewers": ["master"], "ownedForAll": false, "visibleForAll": false}, "position": {"topLeft": {"x": 100, "y": 1200}, "bottomRight": {"x": 500, "y": 1300}}, "appearance": {"text": null, "textColor": {"hex": "000000"}, "backgroundColor": {"hex": "ffffff"}, "backgroundImage": null}}, {"access": {"type": "static", "owners": ["p2"], "viewers": ["master"], "ownedForAll": false, "visibleForAll": false}, "position": {"topLeft": {"x": 600, "y": 1200}, "bottomRight": {"x": 1000, "y": 1300}}, "appearance": {"text": null, "textColor": {"hex": "000000"}, "backgroundColor": {"hex": "ffffff"}, "backgroundImage": null}}, {"access": {"type": "static", "owners": ["p3"], "viewers": ["master"], "ownedForAll": false, "visibleForAll": false}, "position": {"topLeft": {"x": 1100, "y": 1200}, "bottomRight": {"x": 1500, "y": 1300}}, "appearance": {"text": null, "textColor": {"hex": "000000"}, "backgroundColor": {"hex": "ffffff"}, "backgroundImage": null}}], "players": [{"id": "master", "roleName": "Master"}, {"id": "p1", "roleName": "Player 1"}, {"id": "p2", "roleName": "Player 2"}, {"id": "p3", "roleName": "Player 3"}], "gameZone": {"access": {"type": "static", "owners": [], "viewers": [], "ownedForAll": true, "visibleForAll": true}, "position": {"topLeft": {"x": 0, "y": 0}, "bottomRight": {"x": 1600, "y": 1024}}, "appearance": {"text": null, "textColor": {"hex": "000000"}, "backgroundColor": {"hex": "fbad18"}, "backgroundImage": null}}, "description": "The ruleset consists of all possible objects are available in the Myna engine.\nSome of objects are not supported yet.", "rootObjects": {"id": "d851e384-dbfd-4aef-9770-a1948e4af103", "objects": [{"id": "dice", "size": {"width": 20, "height": 20}, "states": [{"id": "1", "appearance": {"text": "⚀", "textColor": {"hex": "000000"}, "backgroundColor": null, "backgroundImage": null}}, {"id": "2", "appearance": {"text": "⚁", "textColor": {"hex": "000000"}, "backgroundColor": null, "backgroundImage": null}}, {"id": "3", "appearance": {"text": "⚂", "textColor": {"hex": "000000"}, "backgroundColor": null, "backgroundImage": null}}, {"id": "4", "appearance": {"text": "⚃", "textColor": {"hex": "000000"}, "backgroundColor": null, "backgroundImage": null}}, {"id": "5", "appearance": {"text": "⚄", "textColor": {"hex": "000000"}, "backgroundColor": null, "backgroundImage": null}}, {"id": "6", "appearance": {"text": "⚅", "textColor": {"hex": "000000"}, "backgroundColor": null, "backgroundImage": null}}], "stateChangeStrategy": "random"}, {"id": "black mark", "size": {"width": 10, "height": 10}, "states": [{"id": "b8acf670-ba57-496a-ba92-7187042c5762", "appearance": {"text": "*", "textColor": {"hex": "000000"}, "backgroundColor": null, "backgroundImage": null}}], "stateChangeStrategy": "fixed"}], "positioningType": "stack"}, "objectsStacks": [{"id": "extras", "objects": [{"id": "4c570b09-f76f-4970-9863-a2370afdc93d", "size": {"width": 30, "height": 10}, "states": [{"id": "3699b12a-1ad8-456e-9557-ca9d9f43bd6c", "appearance": {"text": "Do it again", "textColor": {"hex": "000000"}, "backgroundColor": null, "backgroundImage": null}}], "stateChangeStrategy": "fixed"}, {"id": "1605e5c7-f771-4a95-b2b6-7a03fb63e8f5", "size": {"width": 30, "height": 10}, "states": [{"id": "0f437e73-48c9-43ba-9a64-34a1c31e6d9c", "appearance": {"text": "Two extra steps", "textColor": {"hex": "000000"}, "backgroundColor": null, "backgroundImage": null}}], "stateChangeStrategy": "fixed"}], "positioningType": "stack"}, {"id": "penalties", "objects": [{"id": "0d3ce9ad-76af-4ddc-9054-227cd8884835", "size": {"width": 30, "height": 10}, "states": [{"id": "20d3c689-ff3d-4e51-9a6c-caf654bebbab", "appearance": {"text": "Skip next turn", "textColor": {"hex": "000000"}, "backgroundColor": null, "backgroundImage": null}}], "stateChangeStrategy": "fixed"}, {"id": "ef09fdf4-2b63-4829-9049-6346e3756d90", "size": {"width": 30, "height": 10}, "states": [{"id": "2c3cf034-b212-44ae-ae90-5a3ee57d0e24", "appearance": {"text": "Go two steps back", "textColor": {"hex": "000000"}, "backgroundColor": null, "backgroundImage": null}}], "stateChangeStrategy": "fixed"}], "positioningType": "stack"}]}'),
  ('checkers_v0', '{"id": "checkers_v0", "name": "Checkers (v0-preview)", "zones": [], "players": [{"id": "Whites", "roleName": "Whites"}, {"id": "Blacks", "roleName": "Blacks"}], "gameZone": {"access": {"type": "static", "owners": [], "viewers": [], "ownedForAll": true, "visibleForAll": true}, "position": {"topLeft": {"x": 0, "y": 0}, "bottomRight": {"x": 1024, "y": 1024}}, "appearance": {"text": null, "textColor": {"hex": "000000"}, "backgroundColor": {"hex": "fbad18"}, "backgroundImage": null}}, "description": "Checkers, also known as draughts, is a strategy board game for two players which involve foward movements of uniform game pieces and mandatory captures by jumping over opponent pieces.\nCheckers is played by two opponents on opposite sides of the game board. One player has black pieces the other has white pieces. White moves first, then players alternate turns. A player cannot move the opponent''s pieces. A move consists of moving a piece forward to an adjacent unoccupied square. If the adjacent square contains an opponent''s piece, and the square immediately beyond it is vacant, the piece may be captured (and removed from the game) by jumping over it.", "rootObjects": {"id": "8feede54-0be3-4516-a280-9d754a6ff45d", "objects": [{"id": "b0", "size": {"width": 20, "height": 20}, "states": [{"id": "black", "appearance": {"text": "⚫️", "textColor": {"hex": "000000"}, "backgroundColor": null, "backgroundImage": null}}], "stateChangeStrategy": "fixed"}, {"id": "b1", "size": {"width": 20, "height": 20}, "states": [{"id": "black", "appearance": {"text": "⚫️", "textColor": {"hex": "000000"}, "backgroundColor": null, "backgroundImage": null}}], "stateChangeStrategy": "fixed"}, {"id": "b2", "size": {"width": 20, "height": 20}, "states": [{"id": "black", "appearance": {"text": "⚫️", "textColor": {"hex": "000000"}, "backgroundColor": null, "backgroundImage": null}}], "stateChangeStrategy": "fixed"}, {"id": "b3", "size": {"width": 20, "height": 20}, "states": [{"id": "black", "appearance": {"text": "⚫️", "textColor": {"hex": "000000"}, "backgroundColor": null, "backgroundImage": null}}], "stateChangeStrategy": "fixed"}, {"id": "b4", "size": {"width": 20, "height": 20}, "states": [{"id": "black", "appearance": {"text": "⚫️", "textColor": {"hex": "000000"}, "backgroundColor": null, "backgroundImage": null}}], "stateChangeStrategy": "fixed"}, {"id": "b5", "size": {"width": 20, "height": 20}, "states": [{"id": "black", "appearance": {"text": "⚫️", "textColor": {"hex": "000000"}, "backgroundColor": null, "backgroundImage": null}}], "stateChangeStrategy": "fixed"}, {"id": "b6", "size": {"width": 20, "height": 20}, "states": [{"id": "black", "appearance": {"text": "⚫️", "textColor": {"hex": "000000"}, "backgroundColor": null, "backgroundImage": null}}], "stateChangeStrategy": "fixed"}, {"id": "b7", "size": {"width": 20, "height": 20}, "states": [{"id": "black", "appearance": {"text": "⚫️", "textColor": {"hex": "000000"}, "backgroundColor": null, "backgroundImage": null}}], "stateChangeStrategy": "fixed"}, {"id": "b8", "size": {"width": 20, "height": 20}, "states": [{"id": "black", "appearance": {"text": "⚫️", "textColor": {"hex": "000000"}, "backgroundColor": null, "backgroundImage": null}}], "stateChangeStrategy": "fixed"}, {"id": "b9", "size": {"width": 20, "height": 20}, "states": [{"id": "black", "appearance": {"text": "⚫️", "textColor": {"hex": "000000"}, "backgroundColor": null, "backgroundImage": null}}], "stateChangeStrategy": "fixed"}, {"id": "b10", "size": {"width": 20, "height": 20}, "states": [{"id": "black", "appearance": {"text": "⚫️", "textColor": {"hex": "000000"}, "backgroundColor": null, "backgroundImage": null}}], "stateChangeStrategy": "fixed"}, {"id": "b11", "size": {"width": 20, "height": 20}, "states": [{"id": "black", "appearance": {"text": "⚫️", "textColor": {"hex": "000000"}, "backgroundColor": null, "backgroundImage": null}}], "stateChangeStrategy": "fixed"}, {"id": "w0", "size": {"width": 20, "height": 20}, "states": [{"id": "white", "appearance": {"text": "⚪️", "textColor": {"hex": "000000"}, "backgroundColor": null, "backgroundImage": null}}], "stateChangeStrategy": "fixed"}, {"id": "w1", "size": {"width": 20, "height": 20}, "states": [{"id": "white", "appearance": {"text": "⚪️", "textColor": {"hex": "000000"}, "backgroundColor": null, "backgroundImage": null}}], "stateChangeStrategy": "fixed"}, {"id": "w2", "size": {"width": 20, "height": 20}, "states": [{"id": "white", "appearance": {"text": "⚪️", "textColor": {"hex": "000000"}, "backgroundColor": null, "backgroundImage": null}}], "stateChangeStrategy": "fixed"}, {"id": "w3", "size": {"width": 20, "height": 20}, "states": [{"id": "white", "appearance": {"text": "⚪️", "textColor": {"hex": "000000"}, "backgroundColor": null, "backgroundImage": null}}], "stateChangeStrategy": "fixed"}, {"id": "w4", "size": {"width": 20, "height": 20}, "states": [{"id": "white", "appearance": {"text": "⚪️", "textColor": {"hex": "000000"}, "backgroundColor": null, "backgroundImage": null}}], "stateChangeStrategy": "fixed"}, {"id": "w5", "size": {"width": 20, "height": 20}, "states": [{"id": "white", "appearance": {"text": "⚪️", "textColor": {"hex": "000000"}, "backgroundColor": null, "backgroundImage": null}}], "stateChangeStrategy": "fixed"}, {"id": "w6", "size": {"width": 20, "height": 20}, "states": [{"id": "white", "appearance": {"text": "⚪️", "textColor": {"hex": "000000"}, "backgroundColor": null, "backgroundImage": null}}], "stateChangeStrategy": "fixed"}, {"id": "w7", "size": {"width": 20, "height": 20}, "states": [{"id": "white", "appearance": {"text": "⚪️", "textColor": {"hex": "000000"}, "backgroundColor": null, "backgroundImage": null}}], "stateChangeStrategy": "fixed"}, {"id": "w8", "size": {"width": 20, "height": 20}, "states": [{"id": "white", "appearance": {"text": "⚪️", "textColor": {"hex": "000000"}, "backgroundColor": null, "backgroundImage": null}}], "stateChangeStrategy": "fixed"}, {"id": "w9", "size": {"width": 20, "height": 20}, "states": [{"id": "white", "appearance": {"text": "⚪️", "textColor": {"hex": "000000"}, "backgroundColor": null, "backgroundImage": null}}], "stateChangeStrategy": "fixed"}, {"id": "w10", "size": {"width": 20, "height": 20}, "states": [{"id": "white", "appearance": {"text": "⚪️", "textColor": {"hex": "000000"}, "backgroundColor": null, "backgroundImage": null}}], "stateChangeStrategy": "fixed"}, {"id": "w11", "size": {"width": 20, "height": 20}, "states": [{"id": "white", "appearance": {"text": "⚪️", "textColor": {"hex": "000000"}, "backgroundColor": null, "backgroundImage": null}}], "stateChangeStrategy": "fixed"}], "positioningType": "stack"}, "objectsStacks": []}');
-- rollback delete from rulesets where id in ('all_features_v0', 'checkers_v0')

